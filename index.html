<!--
    Twitch Bits/Subscribe Extractor from OneComme
    Version 0.1.2
    Copyright (c) 2025 by maymehbird
-->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Bits/Subscribe Extractor from OneComme</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body>
    <h1>Twitch Bits/Subscribe Extractor from OneComme V0.1.1</h1>
    <div id="lists"></div>
    <script>
        // クリップボードに列をコピーする関数
        function copyColumnToClipboard(tableId, colIndex, event) {
            if (event) event.stopPropagation();
            const table = document.getElementById(tableId);
            if (!table) return;
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const values = rows.map(row => row.children[colIndex].textContent);
            const text = values.join('\n');
            navigator.clipboard.writeText(text);
            alert('クリップボードにコピーしました');
        }

        // 列のコピーアイコンを生成する関数
        function getCopyIcon(tableId, colIndex) {
            return `<button onclick=\"copyColumnToClipboard('${tableId}',${colIndex},event)\" style=\"background:none;border:none;padding:0;cursor:pointer;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 16 16\"><path d=\"M10 1.5A1.5 1.5 0 0 1 11.5 3v1h-1V3a.5.5 0 0 0-.5-.5H4A.5.5 0 0 0 3.5 3v10a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5v-1h1v1A1.5 1.5 0 0 1 10 14.5H4A1.5 1.5 0 0 1 2.5 13V3A1.5 1.5 0 0 1 4 1.5h6z\"/><path d=\"M13.5 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .5-.5h7zm-7-1A1.5 1.5 0 0 0 5 5.5v7A1.5 1.5 0 0 0 6.5 14h7A1.5 1.5 0 0 0 15 12.5v-7A1.5 1.5 0 0 0 13.5 4h-7z\"/></svg></button>`;
        }

        // 共通: ユーザー行生成関数
        function renderUserRows(tbody, users, extraColumns = []) {
            let no = 1;
            Object.entries(users).forEach(([userKey, info]) => {
                let row = `<td>${no++}</td><td>${info.nickname}</td><td>${info.name}</td><td>${info.screenName}</td>`;
                extraColumns.forEach(col => {
                    row += `<td>${info[col] ?? ''}</td>`;
                });
                const tr = document.createElement('tr');
                tr.innerHTML = row;
                tbody.appendChild(tr);
            });
        }

        // 共通: テーブルヘッダー生成関数
        function renderTableHeader(tableId, columns) {
            return `<thead><tr>${columns.map((col, i) => `<th${col.width ? ` style=\"width:${col.width}\"` : ''}>${col.label} ${getCopyIcon(tableId, i)}</th>`).join('')}</tr></thead><tbody></tbody>`;
        }

        // ライブIDごとにテーブルを生成する関数
        function renderLiveTables(liveId, live, parent) {
            // ライブ名のみ表示
            const h2 = document.createElement('h2');
            h2.textContent = live.liveName || '';
            parent.appendChild(h2);

            const bitsTableId = `bits-table-${liveId}`;
            const bitsTable = document.createElement('table');
            bitsTable.className = 'display';
            bitsTable.id = bitsTableId;
            bitsTable.innerHTML = renderTableHeader(bitsTableId, [
                { label: 'No.', width: '60px' },
                { label: 'ニックネーム' },
                { label: 'ユーザー名' },
                { label: 'ユーザーID' },
                { label: '合計ビッツ' }
            ]);
            let bitsTbody = bitsTable.querySelector('tbody');
            renderUserRows(bitsTbody, live.bitsUsers, ['totalPrice']);
            parent.appendChild(document.createElement('h3')).textContent = 'ビッツしたユーザー一覧';
            parent.appendChild(bitsTable);

            const subTableId = `sub-table-${liveId}`;
            const subTable = document.createElement('table');
            subTable.className = 'display';
            subTable.id = subTableId;
            subTable.innerHTML = renderTableHeader(subTableId, [
                { label: 'No.', width: '60px' },
                { label: 'ニックネーム' },
                { label: 'ユーザー名' },
                { label: 'ユーザーID' },
                { label: 'ティア' },
                { label: 'サブスクライブ月' }
            ]);
            let subTbody = subTable.querySelector('tbody');
            renderUserRows(subTbody, live.subUsers, ['tier', 'month']);
            parent.appendChild(document.createElement('h3')).textContent = 'サブスクライブしたユーザー一覧';
            parent.appendChild(subTable);

            const otherGiftTableId = `other-gift-table-${liveId}`;
            const otherGiftTable = document.createElement('table');
            otherGiftTable.className = 'display';
            otherGiftTable.id = otherGiftTableId;
            otherGiftTable.innerHTML = renderTableHeader(otherGiftTableId, [
                { label: 'No.', width: '60px' },
                { label: 'ニックネーム' },
                { label: 'ユーザー名' },
                { label: 'ユーザーID' },
                { label: 'コメント' }
            ]);
            let otherTbody = otherGiftTable.querySelector('tbody');
            renderUserRows(otherTbody, live.otherGiftUsers, ['comment']);
            parent.appendChild(document.createElement('h3')).textContent = 'その他のギフト';
            parent.appendChild(otherGiftTable);

            const commentTableId = `comment-table-${liveId}`;
            const commentTable = document.createElement('table');
            commentTable.className = 'display';
            commentTable.id = commentTableId;
            commentTable.innerHTML = renderTableHeader(commentTableId, [
                { label: 'No.', width: '60px' },
                { label: 'ニックネーム' },
                { label: 'ユーザー名' },
                { label: 'ユーザーID' }
            ]);
            let commentTbody = commentTable.querySelector('tbody');
            renderUserRows(commentTbody, live.commentUsers);
            parent.appendChild(document.createElement('h3')).textContent = 'コメントしたユーザー一覧';
            parent.appendChild(commentTable);

            // DataTables初期化
            setTimeout(() => {
                if ($(`#${bitsTableId}`).length) {
                    $(`#${bitsTableId}`).DataTable();
                }
                if ($(`#${subTableId}`).length) {
                    $(`#${subTableId}`).DataTable();
                }
                if ($(`#${otherGiftTableId}`).length) {
                    $(`#${otherGiftTableId}`).DataTable();
                }
                if ($(`#${commentTableId}`).length) {
                    $(`#${commentTableId}`).DataTable();
                }
            }, 0);
        }

        // 指定idからユーザーデータを取得する関数
        async function fetchUserById(id) {
            const url = `http://localhost:11180/api/users/${id}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('ユーザー取得失敗');
                return await response.json();
            } catch (err) {
                console.error('ユーザー取得エラー', err);
                return null;
            }
        }

        // わんコメAPIからデータを取得して表示する関数
        async function fetchWankomeData() {
            // わんコメHTTP APIのエンドポイント
            const apiUrl = 'http://localhost:11180/api/comments';
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                console.log('API取得成功', data);

                // liveIdごとにデータをグループ化
                const liveGroups = {};
                const nicknameCache = {};
                for (const e of data) {
                    const liveId = e.data.liveId || '不明なライブ';
                    if (!liveGroups[liveId]) {
                        liveGroups[liveId] = { bitsUsers: {}, subUsers: {}, otherGiftUsers: {}, liveName: e.name || '' };
                    }
                    const live = liveGroups[liveId];
                    const userKey = e.data.userId || '';
                    const name = e.data.name || ''; // ユーザー名
                    const screenName = e.data.screenName || ''; // ユーザーID
                    let nickname = e.data.nickname || name; // ニックネーム（なければユーザー名）

                    // users APIを使用してニックネームを取得する。users APIを使うのは一回だけにする
                    // このif-else文を消した場合、最後のコメントを取得した時に設定していたニックネームを使用する
                    if (nicknameCache[userKey]) {
                        nickname = nicknameCache[userKey];
                    } else {
                        const userData = await fetchUserById(userKey);
                        if (userData && userData.nickname) {
                            nickname = userData.nickname;
                        }
                        else {
                            nickname = name; // ニックネームがない場合はユーザー名を使用
                        }
                        nicknameCache[userKey] = nickname;
                    }

                    if (e.data.hasGift === true) {
                        // ビッツ集計
                        if (e.data.price) {
                            const price = e.data.price || 0;
                            if (!live.bitsUsers[userKey]) {
                                live.bitsUsers[userKey] = { name, screenName, nickname, totalPrice: 0 };
                            }
                            live.bitsUsers[userKey].totalPrice += price;
                            if (name) live.bitsUsers[userKey].name = name;
                            if (screenName) live.bitsUsers[userKey].screenName = screenName;
                            if (nickname) live.bitsUsers[userKey].nickname = nickname;
                        }
                        // price未定義の場合
                        else if (typeof e.data.price === "undefined") {
                            // サブスク集計
                            if (e.data.comment && /subscribed at/i.test(e.data.comment)) {
                                let month = '';
                                let tier = '';
                                if (e.data.comment) {
                                    // コメントからティアを抽出
                                    const tierMatch = e.data.comment.match(/subscribed at (Tier \d+)/i);
                                    if (tierMatch) {
                                        tier = tierMatch[1];
                                    }
                                    // コメントから月数を抽出
                                    const monthMatch = e.data.comment.match(/They've subscribed for (\d+\s*\w+)/i);
                                    if (monthMatch) {
                                        month = monthMatch[1];
                                    }
                                }
                                live.subUsers[userKey] = { name, screenName, nickname, tier, month };
                            }
                            // その他のギフト集計
                            else {
                                const comment = e.data.comment || '';
                                if (!live.otherGiftUsers[userKey]) {
                                    live.otherGiftUsers[userKey] = { name, screenName, nickname, comment };
                                } else {
                                    live.otherGiftUsers[userKey].comment += '<br>' + comment;
                                }
                                if (name) live.otherGiftUsers[userKey].name = name;
                                if (screenName) live.otherGiftUsers[userKey].screenName = screenName;
                                if (nickname) live.otherGiftUsers[userKey].nickname = nickname;
                            }
                        }
                    }
                    // コメントしたユーザー集計
                    if (!live.commentUsers) live.commentUsers = {};
                    if (!live.commentUsers[userKey]) {
                        live.commentUsers[userKey] = { name, screenName, nickname };
                    } else {
                        if (name) live.commentUsers[userKey].name = name;
                        if (screenName) live.commentUsers[userKey].screenName = screenName;
                        if (nickname) live.commentUsers[userKey].nickname = nickname;
                    }
                }

                // HTMLに表示
                const listsDiv = document.getElementById('lists');
                listsDiv.innerHTML = '';
                Object.entries(liveGroups).forEach(([liveId, live]) => {
                    renderLiveTables(liveId, live, listsDiv);
                });
            } catch (err) {
                console.error('API取得エラー', err);
            }
        }
        fetchWankomeData();
    </script>
</body>

</html>